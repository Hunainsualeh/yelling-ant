openapi: 3.0.3
info:
  title: QuizBuzz API
  description: |
    BuzzFeed-style Quiz Engine for Yelling Ant
    
    This API powers the QuizBuzz quiz system with support for:
    - Personality quizzes (weighted outcomes)
    - Points-based quizzes (scored ranges)
    - Trivia quizzes (correct/incorrect)
    - Branching quizzes (dynamic question flow)
    
    All routes are namespaced under `/api/quiz` and `/api/admin` for seamless
    integration with the Yelling Ant platform.
  version: 1.0.0
  contact:
    name: Yelling Ant Development Team
    email: dev@yellingant.com

servers:
  - url: http://localhost:5000
    description: Local development server
  - url: https://api.yellingant.com
    description: Production server

tags:
  - name: Quiz
    description: Public quiz endpoints for users
  - name: Admin
    description: Admin endpoints for quiz management
  - name: Analytics
    description: Analytics and tracking endpoints

paths:
  /health:
    get:
      summary: Health check
      description: Check if the API is running
      responses:
        '200':
          description: API is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: healthy
                  timestamp:
                    type: string
                    format: date-time
                  service:
                    type: string
                    example: QuizBuzz API
                  version:
                    type: string
                    example: 1.0.0

  /api/quiz:
    get:
      tags:
        - Quiz
      summary: List all published quizzes
      description: Get a paginated list of all published quizzes
      parameters:
        - name: colony
          in: query
          description: Filter by colony name
          schema:
            type: string
            example: Culture x Life
        - name: tag
          in: query
          description: Filter by tag
          schema:
            type: string
            example: personality
        - name: limit
          in: query
          description: Number of quizzes to return
          schema:
            type: integer
            default: 20
            maximum: 100
        - name: offset
          in: query
          description: Offset for pagination
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: List of quizzes
          content:
            application/json:
              schema:
                type: object
                properties:
                  quizzes:
                    type: array
                    items:
                      $ref: '#/components/schemas/QuizListItem'
                  total:
                    type: integer
                  limit:
                    type: integer
                  offset:
                    type: integer

  /api/quiz/{slug}:
    get:
      tags:
        - Quiz
      summary: Get quiz by slug
      description: Fetch full quiz data by slug
      parameters:
        - name: slug
          in: path
          required: true
          description: Quiz slug (URL-friendly identifier)
          schema:
            type: string
            example: which-brown-auntie-energy-are-you
      responses:
        '200':
          description: Quiz data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Quiz'
        '404':
          description: Quiz not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/quiz/{slug}/related:
    get:
      tags:
        - Quiz
      summary: Get related quizzes
      description: Get quizzes with overlapping tags
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 5
      responses:
        '200':
          description: Related quizzes
          content:
            application/json:
              schema:
                type: object
                properties:
                  quizzes:
                    type: array
                    items:
                      $ref: '#/components/schemas/QuizListItem'

  /api/quiz/{slug}/submit:
    post:
      tags:
        - Quiz
      summary: Submit quiz answers
      description: Submit user answers and receive calculated result
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QuizSubmission'
      responses:
        '200':
          description: Quiz result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QuizResult'
        '400':
          description: Invalid submission
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Quiz not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/admin/quiz:
    get:
      tags:
        - Admin
      summary: List all quizzes (admin)
      description: Get all quizzes including drafts, scheduled, and archived
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [draft, scheduled, published, archived]
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: List of quizzes
          content:
            application/json:
              schema:
                type: object
                properties:
                  quizzes:
                    type: array
                    items:
                      $ref: '#/components/schemas/AdminQuizItem'
                  total:
                    type: integer

    post:
      tags:
        - Admin
      summary: Create new quiz
      description: Create a new quiz (defaults to draft status)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Quiz'
      responses:
        '201':
          description: Quiz created
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  quiz:
                    $ref: '#/components/schemas/AdminQuizItem'

  /api/admin/quiz/{slug}:
    put:
      tags:
        - Admin
      summary: Update quiz
      description: Update an existing quiz and increment version
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Quiz'
      responses:
        '200':
          description: Quiz updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  quiz:
                    $ref: '#/components/schemas/AdminQuizItem'

    delete:
      tags:
        - Admin
      summary: Delete quiz
      description: Soft delete (archive) a quiz
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Quiz archived
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  quiz:
                    type: object

  /api/admin/quiz/{slug}/publish:
    patch:
      tags:
        - Admin
      summary: Publish or unpublish quiz
      description: Change quiz status between draft and published
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - publish
              properties:
                publish:
                  type: boolean
      responses:
        '200':
          description: Quiz status updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  quiz:
                    type: object

  /api/admin/quiz/{slug}/schedule:
    post:
      tags:
        - Admin
      summary: Schedule quiz
      description: Schedule quiz for future publication
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - publish_at
              properties:
                publish_at:
                  type: string
                  format: date-time
                  example: "2025-12-01T10:00:00Z"
      responses:
        '200':
          description: Quiz scheduled
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  quiz:
                    type: object

  /api/admin/quiz/{slug}/rollback:
    post:
      tags:
        - Admin
      summary: Rollback quiz version
      description: Restore a previous version of the quiz
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - version
              properties:
                version:
                  type: integer
                  example: 3
      responses:
        '200':
          description: Version rollback info
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string

  /api/admin/upload:
    post:
      tags:
        - Admin
      summary: Upload images
      description: Upload quiz images (hero, questions, results, etc.)
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                images:
                  type: array
                  items:
                    type: string
                    format: binary
      responses:
        '200':
          description: Upload successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  files:
                    type: array
                    items:
                      $ref: '#/components/schemas/UploadedFile'

  /api/admin/images:
    get:
      tags:
        - Admin
      summary: List uploaded images
      description: Get list of all uploaded images
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
      responses:
        '200':
          description: List of images
          content:
            application/json:
              schema:
                type: object
                properties:
                  images:
                    type: array
                    items:
                      type: object
                      properties:
                        filename:
                          type: string
                        url:
                          type: string
                        uploaded_at:
                          type: string
                          format: date-time

  /api/admin/analytics/{slug}:
    get:
      tags:
        - Admin
      summary: Get quiz analytics
      description: Get comprehensive analytics for a quiz
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Quiz analytics
          content:
            application/json:
              schema:
                type: object
                properties:
                  slug:
                    type: string
                  total_views:
                    type: integer
                  total_completions:
                    type: integer
                  completion_rate:
                    type: string
                  events:
                    type: array
                    items:
                      type: object
                      properties:
                        event_type:
                          type: string
                        count:
                          type: integer
                  outcome_distribution:
                    type: array
                    items:
                      type: object
                      properties:
                        outcome:
                          type: string
                        count:
                          type: integer

  /api/analytics/track:
    post:
      tags:
        - Analytics
      summary: Track analytics event
      description: Track user interactions and quiz events
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - quiz_slug
                - event_type
              properties:
                quiz_slug:
                  type: string
                  example: which-brown-auntie-energy-are-you
                event_type:
                  type: string
                  enum:
                    - quiz_view
                    - quiz_start
                    - quiz_question_answered
                    - quiz_completed
                    - quiz_retaken
                    - quiz_share_click
                    - quiz_result_impression
                    - quiz_result_badge_awarded
                    - quiz_related_quiz_click
                event_data:
                  type: object
                user_id:
                  type: string
                session_id:
                  type: string
      responses:
        '201':
          description: Event tracked
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  event_type:
                    type: string

components:
  schemas:
    AdminQuizItem:
      type: object
      properties:
        id:
          type: integer
        slug:
          type: string
        title:
          type: string
        status:
          type: string
          enum: [draft, scheduled, published, archived]
        version:
          type: integer
        publish_at:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    Quiz:
      type: object
      required:
        - title
        - slug
        - type
        - primary_colony
        - hero_image
        - questions
        - results
      properties:
        title:
          type: string
          description: Quiz headline
        dek:
          type: string
          description: Subheadline/description
        slug:
          type: string
          description: URL-friendly identifier
        type:
          type: string
          enum: [personality, points, trivia, branching]
        primary_colony:
          type: string
        secondary_colonies:
          type: array
          items:
            type: string
          maxItems: 2
        tags:
          type: array
          items:
            type: string
        hero_image:
          type: string
          format: uri
        theme:
          $ref: '#/components/schemas/QuizTheme'
        questions:
          type: array
          items:
            $ref: '#/components/schemas/Question'
        results:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/Result'
        seo:
          $ref: '#/components/schemas/SEO'
        ad_config:
          $ref: '#/components/schemas/AdConfig'

    QuizTheme:
      type: object
      properties:
        bg_color:
          type: string
          pattern: '^#[0-9A-Fa-f]{6}$'
        primary_color:
          type: string
          pattern: '^#[0-9A-Fa-f]{6}$'
        text_color:
          type: string
          pattern: '^#[0-9A-Fa-f]{6}$'
        font_family:
          type: string
        button_style:
          type: string
          enum: [rounded, pill, square]
        progress_style:
          type: string
          enum: [thin, thick]

    Question:
      type: object
      required:
        - id
        - text
        - options
      properties:
        id:
          type: string
        text:
          type: string
        image:
          type: string
          format: uri
        type:
          type: string
          enum: [single, multi-select, trivia, branching]
        shuffle:
          type: boolean
        min_select:
          type: integer
        max_select:
          type: integer
        options:
          type: array
          items:
            $ref: '#/components/schemas/Option'

    Option:
      type: object
      required:
        - id
        - text
      properties:
        id:
          type: string
        text:
          type: string
        image:
          type: string
          format: uri
        map:
          type: object
          additionalProperties:
            type: number
        points:
          type: number
        correct:
          type: boolean
        next:
          type: string

    Result:
      type: object
      required:
        - title
        - description
        - image
      properties:
        title:
          type: string
        description:
          type: string
        image:
          type: string
          format: uri
        theme_color:
          type: string
        badge:
          type: string
        explanation:
          type: string
        colony_prompts:
          type: array
          items:
            type: string

    SEO:
      type: object
      properties:
        title:
          type: string
        description:
          type: string
        og_image:
          type: string
          format: uri
        noindex:
          type: boolean
        utm_template:
          type: string

    AdConfig:
      type: object
      properties:
        enabled_slots:
          type: array
          items:
            type: string
        scroll_trigger_slots:
          type: array
          items:
            type: object
            properties:
              slot:
                type: string
              trigger_percent:
                type: integer

    QuizListItem:
      type: object
      properties:
        id:
          type: integer
        slug:
          type: string
        title:
          type: string
        dek:
          type: string
        hero_image:
          type: string
        tags:
          type: array
          items:
            type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    QuizSubmission:
      type: object
      required:
        - answers
      properties:
        answers:
          type: array
          items:
            type: object
            required:
              - questionId
              - selectedOptions
            properties:
              questionId:
                type: string
                example: q1
              selectedOptions:
                type: array
                items:
                  type: string
                example: [q1-opt1]
        userId:
          type: string
          example: user1234
        sessionId:
          type: string
          example: session5678

    QuizResult:
      type: object
      properties:
        outcome_key:
          type: string
        outcome:
          $ref: '#/components/schemas/Result'
        score:
          type: number
        total_possible:
          type: number
        percentage:
          type: number
        share_url:
          type: string
          format: uri
        share_image:
          type: string
          format: uri

    UploadedFile:
      type: object
      properties:
        originalName:
          type: string
        filename:
          type: string
        url:
          type: string
          format: uri
        cdnUrl:
          type: string
          format: uri
        size:
          type: integer

    Error:
      type: object
      properties:
        error:
          type: string
        message:
          type: string
        status:
          type: integer
        path:
          type: string
        timestamp:
          type: string
          format: date-time
